<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no" />
        <title>Sample Map demonstration of ArcGIS JavaScript APIs</title>
        <!--jQuery-->
        <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
        <!-- to use the ArcGIS JS API, you need to have an ArcGIS Developer Subscription -->
        <link rel="stylesheet" href="https://js.arcgis.com/4.15/esri/themes/light/main.css" />
        <script src="https://js.arcgis.com/4.15/"></script>

        <style>
            html, body, #mapContainer {
                padding: 0; margin: 0; height: 100%; width: 100%;
            }
        </style>

        <script src="libraries.json"></script>
        <script src="shoppingMalls.json"></script>

        <script>
            var BC_CENTER_LATITUDE = 53.239622280409575;
            var BC_CENTER_LONGITUDE = -130.122070312500005;
            var DEFAULT_ZOOM_LEVEL = 8;

            // assign min/max longitude/latitude for extent
            var minLng = 0;
            var minLat = 0;
            var maxLng = 0;
            var maxLat = 0;

            // esri/Map: loads code specific to creating a map
            // esri/views/MapView: loads code that allows for viewing the map in 2D
            // esri/widgets/Search: search widget to look for a given address
            // esri/Graphic: a visual element representing a feature on a map
            // esri/layers/GraphicsLayer: a layer containing a collection of graphics displayed on map
            // esri/layers/GeoJSONLayer: used to create a layer based on GeoJSON
            // esri/layers/support/LabelClass: label expressions, symbols, scale ranges, label priorities, and label placement options for labels on a layer
            // esri/symbols/PictureMarkerSymbol: renders Point graphics in either a 2D MapView or 3D SceneView using an image
            // esri/geometry/Extent: The minimum and maximum X and Y coordinates of a bounding box. Extent is used to describe the visible portion of a MapView
            require(["esri/Map", "esri/views/MapView", "esri/widgets/Search", "esri/Graphic", "esri/layers/GraphicsLayer", "esri/layers/GeoJSONLayer", "esri/symbols/PictureMarkerSymbol", "esri/geometry/Extent"], function(Map, MapView, Search, Graphic, GraphicsLayer, GeoJSONLayer, PictureMarkerSymbol, Extent){
                var map = new Map({
                    basemap: "streets" //e.g. street, topo-vector and etc. https://developers.arcgis.com/javascript/latest/api-reference/esri-Map.html#basemap
                });

                var view = new MapView({
                    container: "mapContainer",
                    map: map,
                    center: [BC_CENTER_LONGITUDE, BC_CENTER_LATITUDE],
                    zoom: DEFAULT_ZOOM_LEVEL
                });

                var search = new Search({
                    view: view
                });

                view.ui.add(search, "top-right"); // add Search widget to the top-right of the map view.

                //// The below implementation is for loading GeoJSON data into a layer; however, there are some limitations like no custom symbol, valid web URL requirement for GeoJSON and etc.
                // var libraryGeoJSONLayer = new GeoJSONLayer({
                //     url: "http://localhost:8085/ex/emergencyservices/libraries.json" // must be a valid URL. Note: tab needs to be replaced to white spaces; or invalid character
                // });
                
                // libraryGeoJSONLayer.when(function(){
                //     view.extent = libraryGeoJSONLayer.fullExtent;
                // });
                // map.add(libraryGeoJSONLayer);

                addLibraryLayer();
                addShoppingMallLayer();

                // libraryLayer.when(function(){
                //     zoomToLayer(libraryLayer);
                // });

                //// goto single point
                // view.goTo({
                //     center: libraries.features[0].geometry.coordinates,
                //     zoom: 15
                // });

                function addLibraryLayer() {
                    var libraryLayer = new GraphicsLayer();
                    map.add(libraryLayer);

                    //// JS Implementation
                    for (var i = 0, len = libraries.features.length; i < len; ++i) {
                        var lib = libraries.features[i];
                        var lng = lib.geometry.coordinates[0];
                        var lat = lib.geometry.coordinates[1];

                        setMinMaxCoordinates(lng, lat);

                        var point = {
                            type: "point",
                            longitude: lng,
                            latitude: lat
                        };
                        var libsymb = {
                            type: "simple-marker",
                            // type: "picture-marker", //mapview-template-store error: Unable to fetch requested texture resources
                            // url: "https://static.arcgis.com/images/Symbols/Shapes/BlackStarLargeB.png",
                            color: [226, 119, 40],  // orange
                        };
                        var libProp = lib.properties;

                        var pointGraph = new Graphic({
                            geometry: point,
                            symbol: libsymb,
                            attributes: libProp,
                            popupTemplate: {
                                title: "<b>{name}</b>",
                                content: "Address: {address}<br/>Phone: {phone}"
                            }
                        });                    

                        libraryLayer.add(pointGraph);
                    }

                }

                function addShoppingMallLayer() {
                    var shoppingMallLayer = new GraphicsLayer();
                    map.add(shoppingMallLayer);

                    ////jQuery implemenetation: may throw Resource or memory issue
                    $.each(malls.features, function(i, obj){
                        var lng = obj.geometry.coordinates[0];
                        var lat = obj.geometry.coordinates[1];
                        var point = {
                            type: "point",
                            longitude: lng,
                            latitude: lat
                        };

                        setMinMaxCoordinates(lng, lat);

                        var mallSymbol = {
                            type: "simple-marker",
                            color: [40, 119, 226],  // ???
                        };

                        var mallProp = obj.properties;

                        var pointGraphic = new Graphic({
                            geometry: point,
                            symbol: mallSymbol, 
                            attributes: mallProp,
                            popupTemplate: {
                            title: "<b>{name}</b>",
                            content: "Address: {address}<br/>Phone: {phone}"
                            }
                        });
                        shoppingMallLayer.add(pointGraphic);
                    });

                    //// Not work properly for multiple layers
                    // libraryLayer.when(function(){
                    //     view.extent = libraryLayer.fullExtent;
                    // });
                }

                //// update view extent based on min/max longitude/latitude
                view.extent = new Extent({
                    xmin: minLng,
                    ymin: minLat,
                    xmax: maxLng, 
                    ymax: maxLat
                });    

            });

            function setMinMaxCoordinates(lng, lat) {
                if (minLng == 0 || lng < minLng) {
                    minLng = lng;
                }

                if (minLat == 0 || lat < minLat) {
                    minLat = lat;
                }

                if (maxLng == 0 || lng > maxLng) {
                    maxLng = lng;
                }

                if (maxLat == 0 || lat > maxLat) {
                    maxLat = lat;
                }
            }

            //// Not working for JS client API            
            // function zoomToLayer(layer) {
            //     return layer.queryExtent().then(function(response) {
            //         view.goTo(response.extent).catch(function(error) {
            //         if (error.name != "AbortError") {
            //             console.error(error);
            //         }
            //         });
            //     });
            // }
        </script>
    </head>

    <body>
        <div id="mapContainer"></div>

        <script type="text/javascript">
           
        </script>
    </body>
</html>